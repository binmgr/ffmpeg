name: Build FFmpeg Static Binaries

on:
  push:
    branches: [main, master]
    paths:
      - 'docker/**'
      - '.github/workflows/build.yml'
  schedule:
    - cron: '0 0 1 */3 *'
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version (empty for latest)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: binmgr/ffmpeg

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Get FFmpeg Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.ffmpeg_version }}" ]; then
            VERSION="${{ github.event.inputs.ffmpeg_version }}"
          else
            VERSION=$(curl -s https://ffmpeg.org/releases/ | grep -oP 'ffmpeg-\K[0-9]+\.[0-9]+(\.[0-9]+)?' | sort -V | tail -1)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT

  build:
    name: Build (${{ matrix.arch }})
    needs: get-version
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/binmgr/ffmpeg:build
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Build FFmpeg
        run: build-ffmpeg ${{ matrix.arch }} ${{ needs.get-version.outputs.version }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-${{ matrix.arch }}
          path: |
            /output/ffmpeg-linux-${{ matrix.arch }}
            /output/ffprobe-linux-${{ matrix.arch }}
          retention-days: 1

  release:
    name: Release
    needs: [get-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Prepare release
        run: |
          mkdir -p release
          cp artifacts/* release/
          chmod +x release/*
          cd release
          sha256sum * > checksums.txt

      - name: Delete existing release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ needs.get-version.outputs.tag }}" \
            --repo "${{ github.repository }}" --yes --cleanup-tag 2>/dev/null || true

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.get-version.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --title "FFmpeg ${{ needs.get-version.outputs.version }}" \
            --notes "## FFmpeg ${{ needs.get-version.outputs.version }} Static Builds

          Fully static FFmpeg binaries (musl libc).

          | Platform | ffmpeg | ffprobe |
          |----------|--------|---------|
          | Linux AMD64 | \`ffmpeg-linux-amd64\` | \`ffprobe-linux-amd64\` |
          | Linux ARM64 | \`ffmpeg-linux-arm64\` | \`ffprobe-linux-arm64\` |

          ### Docker
          \`\`\`bash
          docker run --rm ghcr.io/binmgr/ffmpeg:latest -version
          \`\`\`

          ### Verify
          \`\`\`bash
          sha256sum -c checksums.txt
          \`\`\`" \
            release/*

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare image context
        run: |
          cp release/ffmpeg-linux-amd64 .
          cp release/ffmpeg-linux-arm64 .
          cp release/ffprobe-linux-amd64 .
          cp release/ffprobe-linux-arm64 .

      - name: Build and push runtime image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.get-version.outputs.version }}
