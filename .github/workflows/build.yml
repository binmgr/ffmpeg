name: Build FFmpeg Static Binaries

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version (empty for latest)'
        required: false
        default: ''

jobs:
  get-version:
    runs-on: ubuntu-latest
    container: ghcr.io/binmgr/toolchain:latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Get FFmpeg Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.ffmpeg_version }}" ]; then
            VERSION="${{ github.event.inputs.ffmpeg_version }}"
          else
            VERSION=$(curl -s https://ffmpeg.org/releases/ | grep -oP 'ffmpeg-\K[0-9]+\.[0-9]+(\.[0-9]+)?' | sort -V | tail -1)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT

      - name: Download FFmpeg Source
        run: |
          wget "https://ffmpeg.org/releases/ffmpeg-${{ steps.version.outputs.version }}.tar.xz"
          mv ffmpeg-${{ steps.version.outputs.version }}.tar.xz ffmpeg-source.tar.xz

      - name: Upload Source Archive
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-source
          path: ffmpeg-source.tar.xz
          retention-days: 1

  build:
    needs: get-version
    runs-on: ubuntu-latest
    container: ghcr.io/binmgr/toolchain:latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: linux, arch: amd64, cross: x86_64-linux-musl, target_os: linux, ext: "" }
          - { os: linux, arch: arm64, cross: aarch64-linux-musl, target_os: linux, ext: "" }
          - { os: windows, arch: amd64, cross: x86_64-w64-mingw32, target_os: mingw32, ext: ".exe" }
          - { os: windows, arch: arm64, cross: aarch64-w64-mingw32, target_os: mingw32, ext: ".exe" }
          - { os: darwin, arch: amd64, cross: x86_64-apple-darwin23, target_os: darwin, ext: "" }
          - { os: darwin, arch: arm64, cross: aarch64-apple-darwin23, target_os: darwin, ext: "" }
    steps:
      - name: Configure Cross Compiler
        run: |
          # All toolchains are pre-installed in the custom Docker image
          case "${{ matrix.os }}-${{ matrix.arch }}" in
            linux-amd64)
              # Native musl build on x86_64
              echo "CC=gcc" >> $GITHUB_ENV
              echo "CXX=g++" >> $GITHUB_ENV
              echo "CROSS_PREFIX=" >> $GITHUB_ENV
              ;;
            linux-arm64)
              # Use pre-installed musl cross-compiler for ARM64
              echo "CC=aarch64-linux-musl-gcc" >> $GITHUB_ENV
              echo "CXX=aarch64-linux-musl-g++" >> $GITHUB_ENV
              echo "CROSS_PREFIX=aarch64-linux-musl-" >> $GITHUB_ENV
              ;;
            windows-amd64)
              # Use pre-installed MinGW
              echo "CC=x86_64-w64-mingw32-gcc" >> $GITHUB_ENV
              echo "CXX=x86_64-w64-mingw32-g++" >> $GITHUB_ENV
              echo "CROSS_PREFIX=x86_64-w64-mingw32-" >> $GITHUB_ENV
              ;;
            windows-arm64)
              # Use pre-installed LLVM MinGW for ARM64
              echo "CC=aarch64-w64-mingw32-gcc" >> $GITHUB_ENV
              echo "CXX=aarch64-w64-mingw32-g++" >> $GITHUB_ENV
              echo "CROSS_PREFIX=aarch64-w64-mingw32-" >> $GITHUB_ENV
              ;;
            darwin-amd64)
              # Use pre-installed OSXCross for macOS AMD64
              echo "CC=x86_64-apple-darwin23-clang" >> $GITHUB_ENV
              echo "CXX=x86_64-apple-darwin23-clang++" >> $GITHUB_ENV
              echo "CROSS_PREFIX=x86_64-apple-darwin23-" >> $GITHUB_ENV
              ;;
            darwin-arm64)
              # Use pre-installed OSXCross for macOS ARM64
              echo "CC=aarch64-apple-darwin23-clang" >> $GITHUB_ENV
              echo "CXX=aarch64-apple-darwin23-clang++" >> $GITHUB_ENV
              echo "CROSS_PREFIX=aarch64-apple-darwin23-" >> $GITHUB_ENV
              ;;
          esac

      - name: Download FFmpeg
        run: |
          wget "https://ffmpeg.org/releases/ffmpeg-${{ needs.get-version.outputs.version }}.tar.xz"
          tar xJf ffmpeg-*.tar.xz
          rm -f ffmpeg-*.tar.xz
          mv ffmpeg-* ffmpeg-src

      - name: Build FFmpeg
        run: |
          cd ffmpeg-src
          mkdir -p ../output

          CONFIGURE_FLAGS="
            --prefix=$PWD/../output
            --enable-gpl
            --enable-version3
            --enable-nonfree
            --enable-static
            --disable-shared
            --disable-debug
            --disable-doc
            --disable-ffplay
            --pkg-config-flags=--static
          "

          # Add cross-compile flags only when needed
          if [ -n "${CROSS_PREFIX}" ]; then
            CONFIGURE_FLAGS="${CONFIGURE_FLAGS}
              --enable-cross-compile
              --cross-prefix=${CROSS_PREFIX}
              --arch=${{ matrix.arch }}
              --target-os=${{ matrix.target_os }}
            "
          fi

          # Try static linking, fall back to dynamic if it fails
          CONFIGURE_FLAGS="${CONFIGURE_FLAGS} --extra-ldflags=-static"

          ./configure ${CONFIGURE_FLAGS} || { cat ffbuild/config.log; exit 1; }
          make -j$(nproc)
          make install

      - name: Strip Binary
        run: |
          BINARY="output/bin/ffmpeg${{ matrix.ext }}"
          ${CROSS_PREFIX}strip "${BINARY}" 2>/dev/null || strip "${BINARY}" 2>/dev/null || true

          # Strip any suffixes from os and arch to ensure clean naming
          OS="${{ matrix.os }}"
          ARCH="${{ matrix.arch }}"
          OS="${OS%%-*}"      # Remove everything after first dash (e.g., linux-gnu -> linux)
          ARCH="${ARCH%%-*}"  # Remove everything after first dash (e.g., amd64-musl -> amd64)

          mv "${BINARY}" "ffmpeg-${OS}-${ARCH}${{ matrix.ext }}"

      - name: Upload Artifact
        run: |
          # Strip any suffixes from os and arch to ensure clean naming
          OS="${{ matrix.os }}"
          ARCH="${{ matrix.arch }}"
          OS="${OS%%-*}"      # Remove everything after first dash
          ARCH="${ARCH%%-*}"  # Remove everything after first dash

          echo "Uploading ffmpeg-${OS}-${ARCH}${{ matrix.ext }}"

          mkdir -p artifact-upload
          mv "ffmpeg-${OS}-${ARCH}${{ matrix.ext }}" artifact-upload/

          # Save artifact name for the upload action
          echo "ARTIFACT_NAME=ffmpeg-${OS}-${ARCH}" >> $GITHUB_ENV
          echo "ARTIFACT_PATH=artifact-upload" >> $GITHUB_ENV

      - name: Upload Artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 1

  release:
    needs: [get-version, build]
    runs-on: ubuntu-latest
    container: ghcr.io/binmgr/toolchain:latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Prepare Release
        run: |
          mkdir -p release
          mv artifacts/* release/ 2>/dev/null || mv artifacts/*/* release/
          cd release
          chmod +x ffmpeg-linux-* ffmpeg-darwin-* 2>/dev/null || true

          # Generate checksums for all release files (binaries + source)
          sha256sum ffmpeg-* > checksums.txt

      - name: Delete Existing Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete "${{ needs.get-version.outputs.tag }}" --repo "${{ github.repository }}" --yes --cleanup-tag 2>/dev/null || true

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.get-version.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --title "FFmpeg ${{ needs.get-version.outputs.version }}" \
            --notes "## FFmpeg ${{ needs.get-version.outputs.version }} Static Builds

          Fully static FFmpeg binaries with all features enabled.

          | Platform | AMD64 | ARM64 |
          |----------|-------|-------|
          | Linux | \`ffmpeg-linux-amd64\` | \`ffmpeg-linux-arm64\` |
          | Windows | \`ffmpeg-windows-amd64.exe\` | \`ffmpeg-windows-arm64.exe\` |
          | macOS | \`ffmpeg-darwin-amd64\` | \`ffmpeg-darwin-arm64\` |

          **Source**: \`ffmpeg-source.tar.xz\` (GPL compliance)

          **Build**: Truly Static (musl libc) | Stripped | GPL v2+

          **Portability**: Linux binaries run on any Linux distribution (no glibc dependency)

          Verify: \`sha256sum -c checksums.txt\`" \
            release/*
